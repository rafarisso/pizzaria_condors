<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Pizzaria Condors - Painel de Pedidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0b0b; --card:#141414; --soft:#1d1d1d;
  --text:#f5f5f5; --muted:#a9a9a9; --accent:#e53935;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:"Sora","Helvetica Neue",sans-serif;
}
.wrap{max-width:900px;margin:0 auto;padding:24px 18px 60px}
.top{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
h1{font-family:"Fraunces",serif;font-size:26px;margin:0}
.muted{color:var(--muted)}
.btn{
  appearance:none;border:0;cursor:pointer;color:#fff;
  background:var(--accent);font-weight:700;border-radius:10px;
  padding:10px 14px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
}
.btn.sec{background:rgba(255,255,255,.1);color:#f0f0f0}
.list{display:grid;gap:12px;margin-top:16px}
.card{
  background:var(--card);border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:12px 14px;display:grid;gap:8px;
}
.row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.items{display:grid;gap:6px}
.item{display:flex;justify-content:space-between;gap:10px}
.tag{display:inline-flex;gap:6px;align-items:center;font-size:12px;background:var(--soft);padding:4px 8px;border-radius:999px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.filter{
  background:var(--soft);color:var(--text);
  border:1px solid rgba(255,255,255,.12);
  padding:8px 10px;border-radius:10px;font-size:14px;
}
.empty{
  padding:16px;border:1px dashed rgba(255,255,255,.2);
  border-radius:12px;text-align:center;color:var(--muted)
}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Pedidos</h1>
      <div id="status" class="muted">Aguardando configuração do Sheets.</div>
    </div>
    <div class="actions">
      <label class="muted" for="filter-status">Status:</label>
      <select id="filter-status" class="filter">
        <option value="PENDENTE" selected>Pendentes</option>
        <option value="TODOS">Todos</option>
        <option value="IMPRESSO">Impressos</option>
      </select>
      <label class="muted" for="filter-period">Período:</label>
      <select id="filter-period" class="filter">
        <option value="HOJE" selected>Hoje</option>
        <option value="ONTEM">Ontem</option>
        <option value="SEMANA">Semana</option>
        <option value="MES">Mês</option>
        <option value="TODOS">Todos</option>
      </select>
      <button id="btn-refresh" class="btn sec" type="button">Atualizar</button>
      <a class="btn sec" href="index.html?atendente=1" target="_blank" rel="noopener">Novo pedido</a>
    </div>
  </div>

  <div id="orders" class="list"></div>
</div>

<script>
const SHEETS_WEBAPP_URL = '/.netlify/functions/sheets-get';
const BRL = v => Number(v || 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const COMANDA_PAD = 5;
const ordersEl=document.getElementById('orders');
const statusEl=document.getElementById('status');
const filterSelect=document.getElementById('filter-status');
const periodSelect=document.getElementById('filter-period');
let CURRENT_ORDERS=[];
let CURRENT_FILTER='PENDENTE';
let CURRENT_PERIOD='HOJE';

function fmtDate(value){
  if(!value) return '';
  const d=new Date(value);
  if(Number.isNaN(d.getTime())) return value;
  return d.toLocaleString('pt-BR');
}

function buildAddress(o){
  const a=o.address || {};
  const parts=[];
  if(a.rua) parts.push(a.rua);
  if(a.num) parts.push(a.num);
  if(a.comp) parts.push(a.comp);
  const line1=parts.join(', ');
  const line2=[a.bairro,a.cidade,a.cep].filter(Boolean).join(' - ');
  return [line1,line2].filter(Boolean).join(' | ');
}

function buildAddressLines(o){
  const a=o.address || {};
  const lines=[];
  const line1=[a.rua,a.num].filter(Boolean).join(', ');
  if(line1) lines.push(line1);
  const line2=[a.bairro,a.cidade].filter(Boolean).join(' - ');
  if(line2) lines.push(line2);
  if(a.cep) lines.push(`CEP ${a.cep}`);
  if(a.comp) lines.push(`Comp: ${a.comp}`);
  if(a.ref) lines.push(`Ref: ${a.ref}`);
  return lines;
}

function parseOrderDate(order){
  const d=new Date(order && order.createdAt ? order.createdAt : '');
  return Number.isNaN(d.getTime()) ? null : d;
}

function dayKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function padComanda(value){
  if(!Number.isFinite(value)) return '';
  return String(value).padStart(COMANDA_PAD, '0');
}

function applyComandaNumbers(list){
  const sorted=(list || []).slice().sort((a,b)=>{
    const da=parseOrderDate(a);
    const db=parseOrderDate(b);
    return (da ? da.getTime() : 0) - (db ? db.getTime() : 0);
  });
  const counters={};
  sorted.forEach(order=>{
    const d=parseOrderDate(order);
    if(!d){
      order.comanda=null;
      order.comandaKey=null;
      return;
    }
    const key=dayKey(d);
    counters[key]=(counters[key] || 0) + 1;
    order.comanda=counters[key];
    order.comandaKey=key;
  });
}

function comandaLabel(order){
  if(!order || !order.comanda) return 'Comanda';
  return `Comanda #${padComanda(order.comanda)}`;
}

function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function normalizeStatus(order){
  const raw = (order && order.status) ? String(order.status) : '';
  const upper = raw.toUpperCase();
  if(upper === 'IMPRESSO') return 'IMPRESSO';
  if(upper === 'PENDENTE') return 'PENDENTE';
  if(order && (order.impresso_em || order.impresso)) return 'IMPRESSO';
  return 'PENDENTE';
}

function matchPeriod(order){
  if(CURRENT_PERIOD === 'TODOS') return true;
  const d=parseOrderDate(order);
  if(!d) return false;
  const now=new Date();
  if(CURRENT_PERIOD === 'HOJE') return isSameDay(d, now);
  if(CURRENT_PERIOD === 'ONTEM'){
    const y=new Date(now);
    y.setDate(now.getDate()-1);
    return isSameDay(d, y);
  }
  if(CURRENT_PERIOD === 'SEMANA'){
    const start=new Date(now);
    start.setHours(0,0,0,0);
    start.setDate(start.getDate()-6);
    return d >= start;
  }
  if(CURRENT_PERIOD === 'MES'){
    return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();
  }
  return true;
}

function applyFilter(list){
  return list.filter(o=>{
    const statusOk = CURRENT_FILTER === 'TODOS' || normalizeStatus(o) === CURRENT_FILTER;
    const periodOk = matchPeriod(o);
    return statusOk && periodOk;
  });
}

function renderOrders(list){
  CURRENT_ORDERS=list || [];
  applyComandaNumbers(CURRENT_ORDERS);
  ordersEl.innerHTML='';
  const visible = applyFilter(CURRENT_ORDERS);
  if(!visible.length){
    ordersEl.innerHTML='<div class="empty">Nenhum pedido encontrado.</div>';
    return;
  }
  visible.forEach(order=>{
    const card=document.createElement('div');
    card.className='card';
    const customer=order.customer || {};
    const totals=order.totals || {};
    const items=order.items || [];
    const orderId = order.id || 'Pedido';
    const status = normalizeStatus(order);
    const printLabel = status === 'IMPRESSO' ? 'Imprimir novamente' : 'Imprimir';
    card.innerHTML=`
      <div class="row">
        <strong>${comandaLabel(order)}</strong>
        <span class="tag">${status}</span>
      </div>
      <div class="row">
        <span class="muted">Pedido: ${orderId}</span>
        <span class="muted">${fmtDate(order.createdAt)}</span>
      </div>
      <div class="row">
        <span>${customer.nome || 'Cliente'}</span>
        <span class="muted">${customer.tel || ''}</span>
      </div>
      <div class="muted">${buildAddress(order)}</div>
      <div class="items">
        ${items.map(it=>`<div class="item"><span>${it.nome}${it.det?`<div class="muted">${it.det}</div>`:''}</span><strong>${BRL(it.preco)}</strong></div>`).join('')}
      </div>
      <div class="row">
        <span>Subtotal</span><strong>${BRL(totals.subtotal)}</strong>
      </div>
      <div class="row">
        <span>Taxa</span><strong>${BRL(totals.taxa)}</strong>
      </div>
      <div class="row">
        <span>Desconto</span><strong>${BRL(totals.desconto)}</strong>
      </div>
      <div class="row">
        <span>Total</span><strong>${BRL(totals.total)}</strong>
      </div>
      <div class="actions">
        <button class="btn" data-print="${order.id}">${printLabel}</button>
      </div>
    `;
    ordersEl.appendChild(card);
  });
}

function printOrder(order){
  const customer=order.customer || {};
  const addressLines=buildAddressLines(order);
  const items=order.items || [];
  const totals=order.totals || {};
  const comandaNumber = order && order.comanda ? padComanda(order.comanda) : '';
  const contactLine = customer.tel ? `Contato: ${customer.tel}` : '';
  const addressHtml = addressLines.map(line=>`<div>${line}</div>`).join('');
  const itemsHtml = items.map(it=>{
    const qtd = it.qtd || 1;
    let det = '';
    if(it.det){
      const parts = String(it.det).split(' · ').map(s=>s.trim()).filter(Boolean);
      det = parts.map(line=>`<div class="item-det">- ${line}</div>`).join('');
    }
    return `<div class="item">
      <div class="item-left">
        <div class="item-name">${qtd}x ${it.nome}</div>
        ${det}
      </div>
      <div class="item-price">${BRL(it.preco)}</div>
    </div>`;
  }).join('');
  const w=window.open('', '_blank', 'width=420,height=700');
  if(!w) return;
  w.document.write(`<!doctype html><html><head><meta charset="utf-8">
  <title>Pedido</title>
  <style>
    @page{size:80mm auto;margin:3mm;}
    @media print{body{width:80mm;}}
    body{
      font-family:"Consolas","Lucida Console","Courier New",monospace;
      color:#000;width:80mm;margin:0;font-size:16.5px;line-height:1.28;font-weight:700;
    }
    .logo{display:flex;justify-content:center;margin:0 0 6px;}
    .logo img{width:60mm;max-width:100%;height:auto;}
    .center{text-align:center;}
    .title{font-size:19px;font-weight:700;letter-spacing:1px;margin:0;}
    .comanda-num{font-size:22px;font-weight:700;letter-spacing:2px;margin-top:2px;}
    .muted{color:#000;}
    .sep{border-top:2px dashed #000;margin:8px 0;}
    .row{display:flex;justify-content:space-between;gap:8px;}
    .section-title{font-size:17px;font-weight:700;letter-spacing:1px;text-align:center;margin:4px 0;}
    .items{margin:6px 0;display:grid;gap:6px;}
    .item{display:flex;justify-content:space-between;gap:8px;}
    .item-left{flex:1;}
    .item-name{font-weight:700;font-size:17px;}
    .item-price{font-size:17px;}
    .item-det{margin-top:2px;font-size:15px;font-weight:700;line-height:1.2;}
    .totals{display:grid;gap:4px;}
    .total{font-size:20px;font-weight:700;margin-top:4px;}
    .thanks{text-align:center;margin-top:10px;font-weight:700;font-size:16px;}
  </style></head><body>
  <div class="logo"><img src="images/logo.png" alt="Condors Pizzaria"></div>
  <div class="center title">COMANDA</div>
  <div class="center comanda-num">${comandaNumber ? `#${comandaNumber}` : ''}</div>
  <div class="center muted">${fmtDate(order.createdAt)}</div>
  ${order.id ? `<div class="center muted">Pedido: ${order.id}</div>` : ''}
  <div class="sep"></div>
  <div class="section-title">CLIENTE</div>
  <div class="center"><strong>${customer.nome || 'Cliente'}</strong></div>
  ${contactLine ? `<div class="center muted">${contactLine}</div>` : ''}
  <div class="center muted">${addressHtml}</div>
  <div class="sep"></div>
  <div class="section-title">ITENS</div>
  <div class="items">${itemsHtml}</div>
  <div class="sep"></div>
  <div class="totals">
    <div class="row"><span>Sub-total</span><span>${BRL(totals.subtotal)}</span></div>
    <div class="row"><span>Taxa de Entrega</span><span>${BRL(totals.taxa)}</span></div>
    <div class="row"><span>Desconto</span><span>${BRL(totals.desconto)}</span></div>
  </div>
  <div class="sep"></div>
  <div class="row total"><span>Total</span><span>${BRL(totals.total)}</span></div>
  <div class="sep"></div>
  <div class="thanks">A Condors Pizzaria agradece a preferencia</div>
  </body></html>`);
  w.document.close();
  w.focus();
  w.print();
  w.onafterprint=()=>w.close();
}

async function markPrinted(orderId){
  if(!orderId) return;
  try{
    await fetch('/.netlify/functions/sheets-mark-printed', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id: orderId })
    });
  }catch{
    // falha silenciosa
  }
}

async function fetchOrders(){
  if(!SHEETS_WEBAPP_URL){
    statusEl.textContent='URL do Sheets não configurada.';
    renderOrders([]);
    return;
  }
  statusEl.textContent='Carregando...';
  try{
    const r=await fetch(SHEETS_WEBAPP_URL, {cache:'no-store'});
    const data=await r.json();
    const orders=(data.orders || []).slice().sort((a,b)=>{
      const ta=new Date(a.createdAt || 0).getTime();
      const tb=new Date(b.createdAt || 0).getTime();
      return tb-ta;
    });
    renderOrders(orders);
    const stamp = data.updatedAt ? new Date(data.updatedAt) : new Date();
    const time = stamp.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    statusEl.textContent = `Última atualização: ${time}`;
  }catch{
    statusEl.textContent='Erro ao carregar pedidos.';
  }
}

document.getElementById('btn-refresh').onclick=fetchOrders;
ordersEl.addEventListener('click',ev=>{
  const btn=ev.target.closest('[data-print]');
  if(!btn) return;
  const id=btn.dataset.print;
  const order=CURRENT_ORDERS.find(o=>o.id===id);
  if(order){
    printOrder(order);
    order.status = 'IMPRESSO';
    renderOrders(CURRENT_ORDERS);
    markPrinted(id).then(fetchOrders);
  }
});

if(filterSelect){
  filterSelect.addEventListener('change',()=>{
    CURRENT_FILTER = filterSelect.value;
    renderOrders(CURRENT_ORDERS);
  });
}
if(periodSelect){
  periodSelect.addEventListener('change',()=>{
    CURRENT_PERIOD = periodSelect.value;
    renderOrders(CURRENT_ORDERS);
  });
}

fetchOrders();
setInterval(fetchOrders, 30000);
</script>
</body>
</html>
